name: Deploy to AWS ECS

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

env:
  AWS_REGION: ap-south-1
  ECR_REPOSITORY_GATEWAY: banking/gateway
  ECR_REPOSITORY_AUTH: banking/auth-service
  ECR_REPOSITORY_WALLET: banking/wallet-service
  ECR_REPOSITORY_NOTIFICATION: banking/notification-service
  ECS_CLUSTER: banking-cluster
  
jobs:
  # Build and push Docker images
  build-and-push:
    name: Build and Push Images
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    
    outputs:
      gateway-image: ${{ steps.build-gateway.outputs.image }}
      auth-image: ${{ steps.build-auth.outputs.image }}
      wallet-image: ${{ steps.build-wallet.outputs.image }}
      notification-image: ${{ steps.build-notification.outputs.image }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Gateway image
        id: build-gateway
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY_GATEWAY:$IMAGE_TAG ./gateway
          docker push $ECR_REGISTRY/$ECR_REPOSITORY_GATEWAY:$IMAGE_TAG
          IMAGE_URI=$ECR_REGISTRY/$ECR_REPOSITORY_GATEWAY:$IMAGE_TAG
          echo "image=$IMAGE_URI" >> $GITHUB_OUTPUT
      
      - name: Debug Gateway Image
        run: echo "Gateway image is ${{ steps.build-gateway.outputs.image }}"
      
      - name: Build and push Auth Service image
        id: build-auth
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY_AUTH:$IMAGE_TAG ./services/auth-service
          docker push $ECR_REGISTRY/$ECR_REPOSITORY_AUTH:$IMAGE_TAG
          IMAGE_URI=$ECR_REGISTRY/$ECR_REPOSITORY_AUTH:$IMAGE_TAG
          echo "image=$IMAGE_URI" >> $GITHUB_OUTPUT
      
      - name: Debug Auth Image
        run: echo "Auth image is ${{ steps.build-auth.outputs.image }}"
      
      - name: Build and push Wallet Service image
        id: build-wallet
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY_WALLET:$IMAGE_TAG ./services/wallet-service
          docker push $ECR_REGISTRY/$ECR_REPOSITORY_WALLET:$IMAGE_TAG
          IMAGE_URI=$ECR_REGISTRY/$ECR_REPOSITORY_WALLET:$IMAGE_TAG
          echo "image=$IMAGE_URI" >> $GITHUB_OUTPUT
      
      - name: Debug Wallet Image
        run: echo "Wallet image is ${{ steps.build-wallet.outputs.image }}"
      
      - name: Build and push Notification Service image
        id: build-notification
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY_NOTIFICATION:$IMAGE_TAG ./services/notification-service
          docker push $ECR_REGISTRY/$ECR_REPOSITORY_NOTIFICATION:$IMAGE_TAG
          IMAGE_URI=$ECR_REGISTRY/$ECR_REPOSITORY_NOTIFICATION:$IMAGE_TAG
          echo "image=$IMAGE_URI" >> $GITHUB_OUTPUT

      - name: Debug Notification Image
        run: echo "Notification image is ${{ steps.build-notification.outputs.image }}"

  # Deploy to ECS
  deploy:
    name: Deploy to ECS
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Fill in new image ID for Gateway task definition
        id: task-def-gateway
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: .aws/task-definition-gateway.json
          container-name: gateway
          image: ${{ needs.build-and-push.outputs.gateway-image }}
      
      - name: Deploy Gateway to ECS
        uses: aws-actions/amazon-ecs-deploy-task-definition@v1
        with:
          task-definition: ${{ steps.task-def-gateway.outputs.task-definition }}
          service: banking-gateway-service-kjasbe0z
          cluster: ${{ env.ECS_CLUSTER }}
          wait-for-service-stability: true
      
      - name: Fill in new image ID for Auth Service task definition
        id: task-def-auth
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: .aws/task-definition-auth.json
          container-name: auth-service
          image: ${{ needs.build-and-push.outputs.auth-image }}
      
      - name: Deploy Auth Service to ECS
        uses: aws-actions/amazon-ecs-deploy-task-definition@v1
        with:
          task-definition: ${{ steps.task-def-auth.outputs.task-definition }}
          service: banking-auth-service-48ccrc0b
          cluster: ${{ env.ECS_CLUSTER }}
          wait-for-service-stability: true
      
      - name: Fill in new image ID for Wallet Service task definition
        id: task-def-wallet
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: .aws/task-definition-wallet.json
          container-name: wallet-service
          image: ${{ needs.build-and-push.outputs.wallet-image }}
      
      - name: Deploy Wallet Service to ECS
        uses: aws-actions/amazon-ecs-deploy-task-definition@v1
        with:
          task-definition: ${{ steps.task-def-wallet.outputs.task-definition }}
          service: banking-wallet-service-ov3uhabx
          cluster: ${{ env.ECS_CLUSTER }}
          wait-for-service-stability: true
      
      - name: Fill in new image ID for Notification Service task definition
        id: task-def-notification
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: .aws/task-definition-notification.json
          container-name: notification-service
          image: ${{ needs.build-and-push.outputs.notification-image }}
      
      - name: Deploy Notification Service to ECS
        uses: aws-actions/amazon-ecs-deploy-task-definition@v1
        with:
          task-definition: ${{ steps.task-def-notification.outputs.task-definition }}
          service: banking-notification-service-o79u3gnf
          cluster: ${{ env.ECS_CLUSTER }}
          wait-for-service-stability: true
